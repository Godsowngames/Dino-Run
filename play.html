<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Custom Dino Game</title>
    <link rel="stylesheet" href="ui.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        .game-frame {
            width: 100%;
            height: 200px;
            background: #000;
            border: 3px solid #444;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        #originalGame {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        
        .game-info-panel {
            background: #333;
            border: 3px solid #444;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .player-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .player-avatar {
            width: 60px;
            height: 60px;
            background: #222;
            border: 2px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
        }
        
        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .player-name {
            font-size: 16px;
            color: #f0f0f0;
        }
        
        .share-panel {
            background: #333;
            border: 3px solid #444;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        
        .share-url {
            background: #222;
            border: 2px solid #444;
            color: #f0f0f0;
            padding: 10px;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            width: 100%;
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="ui-container">
        <div class="ui-panel">
            <div class="ui-header">
                <div class="ui-header-title">PLAY CUSTOM DINO GAME</div>
                <div class="ui-header-subtitle" id="gameStatus">LOADING GAME...</div>
            </div>
            
            <div class="game-info-panel" id="gameInfo">
                <div class="player-display">
                    <div class="player-avatar" id="playerAvatar">
                        <!-- Avatar will be loaded here -->
                    </div>
                    <div class="player-name" id="playerName">PLAYER</div>
                </div>
                <div style="font-size: 10px; color: #888; margin-bottom: 10px;">
                    GAME ID: <span id="gameId">------</span>
                </div>
                <div style="font-size: 9px; color: #666;">
                    <span id="jumpSoundStatus">DEFAULT JUMP SOUND</span> | 
                    <span id="deathSoundStatus">DEFAULT DEATH SOUND</span>
                </div>
            </div>
            
            <div class="game-frame">
                <div class="loading" id="loadingScreen">
                    <div class="ui-header-subtitle">LOADING GAME<span class="ui-loading-dots"></span></div>
                    <div style="font-size: 10px; color: #888; margin-top: 10px;">
                        APPLYING CUSTOM SETTINGS
                    </div>
                </div>
                
                <iframe id="originalGame" src="index.html" style="display: none;"></iframe>
            </div>
            
            <div class="ui-button-group">
                <button class="ui-button ui-button-secondary" onclick="window.location.href='home.html'">
                    HOME
                </button>
                <button class="ui-button ui-button-secondary" onclick="window.location.href='create.html'">
                    CREATE NEW
                </button>
                <button class="ui-button ui-button-primary" id="btnStartGame" disabled>
                    START GAME
                </button>
            </div>
            
            <div class="share-panel" id="sharePanel">
                <div style="font-size: 11px; margin-bottom: 10px; color: #f0f0f0;">
                    SHARE THIS GAME
                </div>
                <input type="text" class="share-url" id="shareUrl" readonly>
                <div>
                    <button class="ui-button-small" onclick="copyShareUrl()">COPY LINK</button>
                    <button class="ui-button-small" onclick="shareGame()">SHARE</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        class GameLoader {
            constructor() {
                this.gameId = null;
                this.gameConfig = null;
            }
            
            init() {
                this.getGameIdFromURL();
                this.loadGameConfig();
            }
            
            getGameIdFromURL() {
                const params = new URLSearchParams(window.location.search);
                this.gameId = params.get('gameId');
                
                if (!this.gameId) {
                    this.showError('NO GAME ID PROVIDED');
                    return;
                }
                
                document.getElementById('gameId').textContent = this.gameId;
            }
            
            loadGameConfig() {
                try {
                    const saved = localStorage.getItem(`dino_game_${this.gameId}`);
                    
                    if (saved) {
                        this.gameConfig = JSON.parse(saved);
                        this.displayGameInfo();
                        this.prepareGame();
                    } else {
                        const allGames = JSON.parse(localStorage.getItem('dino_games_all')) || {};
                        if (allGames[this.gameId]) {
                            this.gameConfig = allGames[this.gameId];
                            this.displayGameInfo();
                            this.prepareGame();
                        } else {
                            this.showError('GAME NOT FOUND');
                        }
                    }
                } catch (error) {
                    this.showError('ERROR LOADING GAME');
                }
            }
            
            displayGameInfo() {
                if (!this.gameConfig) return;
                
                document.getElementById('playerName').textContent = this.gameConfig.playerName;
                document.getElementById('gameStatus').textContent = `PLAYING: ${this.gameConfig.playerName}'S GAME`;
                
                const avatarContainer = document.getElementById('playerAvatar');
                if (this.gameConfig.avatarBase64) {
                    const img = document.createElement('img');
                    img.src = this.gameConfig.avatarBase64;
                    img.alt = this.gameConfig.playerName;
                    avatarContainer.innerHTML = '';
                    avatarContainer.appendChild(img);
                } else {
                    avatarContainer.innerHTML = 'ðŸ‘¤';
                }
                
                const jumpStatus = document.getElementById('jumpSoundStatus');
                const deathStatus = document.getElementById('deathSoundStatus');
                jumpStatus.textContent = this.gameConfig.jumpSoundBase64 ? 'CUSTOM JUMP SOUND' : 'DEFAULT JUMP SOUND';
                deathStatus.textContent = this.gameConfig.deathSoundBase64 ? 'CUSTOM DEATH SOUND' : 'DEFAULT DEATH SOUND';
                
                if (this.gameConfig.jumpSoundBase64) jumpStatus.style.color = '#44ff44';
                if (this.gameConfig.deathSoundBase64) deathStatus.style.color = '#44ff44';
                
                if (this.gameConfig.visibility === 'public') {
                    document.getElementById('sharePanel').style.display = 'block';
                    const shareUrl = `${window.location.origin}${window.location.pathname}?gameId=${this.gameId}`;
                    document.getElementById('shareUrl').value = shareUrl;
                }
            }
            
            prepareGame() {
                window.CustomDinoConfig = {
                    jumpSound: this.gameConfig.jumpSoundBase64,
                    deathSound: this.gameConfig.deathSoundBase64,
                    playerName: this.gameConfig.playerName,
                    avatar: this.gameConfig.avatarBase64,
                    isLoaded: true,
                    gameId: this.gameConfig.gameId
                };
                
                setTimeout(() => {
                    this.loadGame();
                }, 500);
            }
            
            loadGame() {
                const iframe = document.getElementById('originalGame');
                const loadingScreen = document.getElementById('loadingScreen');
                
                iframe.style.display = 'block';
                
                iframe.onload = () => {
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        document.getElementById('btnStartGame').disabled = false;
                        document.getElementById('btnStartGame').textContent = 'PRESS SPACE TO START';
                        
                        this.setupGameControls();
                    }, 1000);
                };
                
                iframe.onerror = () => {
                    this.showError('ERROR LOADING GAME');
                };
            }
            
            setupGameControls() {
                document.getElementById('btnStartGame').addEventListener('click', () => {
                    this.startGame();
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' || e.key === ' ') {
                        e.preventDefault();
                        this.startGame();
                    }
                });
            }
            
            startGame() {
                const iframe = document.getElementById('originalGame');
                const iframeWindow = iframe.contentWindow;
                
                iframe.focus();
                
                setTimeout(() => {
                    if (iframeWindow) {
                        const spaceEvent = new KeyboardEvent('keydown', {
                            key: ' ',
                            code: 'Space',
                            keyCode: 32,
                            bubbles: true
                        });
                        iframeWindow.document.dispatchEvent(spaceEvent);
                    }
                }, 100);
            }
            
            showError(message) {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.innerHTML = `
                    <div style="color: #ff4444; font-size: 14px; margin-bottom: 20px;">${message}</div>
                    <button class="ui-button-small" onclick="window.location.href='create.html'">
                        CREATE NEW GAME
                    </button>
                `;
            }
        }
        
        function copyShareUrl() {
            const shareUrl = document.getElementById('shareUrl');
            shareUrl.select();
            try {
                navigator.clipboard.writeText(shareUrl.value);
                alert('Link copied!');
            } catch (err) {
                document.execCommand('copy');
                alert('Link copied!');
            }
        }
        
        function shareGame() {
            const shareUrl = document.getElementById('shareUrl').value;
            if (navigator.share) {
                navigator.share({
                    title: 'Custom Dino Game',
                    text: 'Check out my custom T-Rex game!',
                    url: shareUrl
                });
            } else {
                copyShareUrl();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const loader = new GameLoader();
            loader.init();
        });
    </script>
</body>
</html>